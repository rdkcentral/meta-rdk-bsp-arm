From e8dee76a38397df710fb36704f271befe50d3916 Mon Sep 17 00:00:00 2001
From: mdev <www.matrix.dev@gmail.com>
Date: Mon, 12 Jan 2026 13:20:08 +0200
Subject: [PATCH] fixed high cpu usage when listened interface is down

---
 ieee1905-core/src/ethernet_subject_reception.rs | 17 +++++++++++++----
 1 file changed, 13 insertions(+), 4 deletions(-)

diff --git a/ieee1905-core/src/ethernet_subject_reception.rs b/ieee1905-core/src/ethernet_subject_reception.rs
index 335931a..2407d2b 100644
--- a/ieee1905-core/src/ethernet_subject_reception.rs
+++ b/ieee1905-core/src/ethernet_subject_reception.rs
@@ -64,6 +64,9 @@ struct EthernetMessage {
 }
 
 impl EthernetReceiver {
+    const RETRY_TIMEOUT_MIN: Duration = Duration::from_millis(10);
+    const RETRY_TIMEOUT_MAX: Duration = Duration::from_secs(1);
+
     /// **Create a new `EthernetReceiver`**
     pub fn new() -> Self {
         Self::default()
@@ -135,9 +138,9 @@ impl EthernetReceiver {
 
         info!("Listening on interface: {interface_name} (MAC: {interface_mac})");
         // Since we spawn a blocking task, we need to have an opportunity
-        // to act on shutdown signal, that's why 1 sec. timeout is used.
+        // to act on shutdown signal, that's why timeout is used.
         let config = Config {
-            read_timeout: Some(Duration::from_secs(1)),
+            read_timeout: Some(Self::RETRY_TIMEOUT_MAX),
             ..Default::default()
         };
 
@@ -152,12 +155,18 @@ impl EthernetReceiver {
             let _span = info_span!(parent: None, "ethernet_receiver_reader", task = next_task_id()).entered();
 
             info!("Listening for Ethernet frames...");
+            let mut retry_timeout = Self::RETRY_TIMEOUT_MIN;
             while !notify_tx.is_closed() {
                 let packet = match datalink_rx.next() {
-                    Ok(e) => e,
+                    Ok(e) => {
+                        retry_timeout = Self::RETRY_TIMEOUT_MIN;
+                        e
+                    },
                     Err(e) => {
                         if e.kind() != ErrorKind::TimedOut {
-                            error!("Error receiving Ethernet frame: {e:?}");
+                            error!("Error receiving Ethernet frame: {e}");
+                            std::thread::sleep(retry_timeout);
+                            retry_timeout = (retry_timeout * 4).min(Self::RETRY_TIMEOUT_MAX);
                         }
                         continue;
                     }
-- 
2.51.2

