From f1ce2df2245be59527bdbb574ca90a6c5efee601 Mon Sep 17 00:00:00 2001
From: mdev <www.matrix.dev@gmail.com>
Date: Thu, 25 Dec 2025 22:46:55 +0200
Subject: [PATCH 2/3] decouple tokio console filtering from main logger

---
 ieee1905-core/src/cmdu_handler.rs |   8 +-
 ieee1905-core/src/main.rs         | 123 +++++++++++-------------------
 2 files changed, 48 insertions(+), 83 deletions(-)

diff --git a/ieee1905-core/src/cmdu_handler.rs b/ieee1905-core/src/cmdu_handler.rs
index 9876052..0acdf6d 100644
--- a/ieee1905-core/src/cmdu_handler.rs
+++ b/ieee1905-core/src/cmdu_handler.rs
@@ -152,7 +152,7 @@ impl CMDUHandler {
                         )
                         .await
                     {
-                        error!("Error forwarding SDU from TopologyNotification interoperability (msg_id={message_id}): {e:?}");
+                        error!(%e, "Error forwarding SDU from TopologyNotification interoperability (msg_id={message_id})");
                     }
                 }
             }
@@ -171,7 +171,7 @@ impl CMDUHandler {
                         )
                         .await
                     {
-                        error!("Error forwarding SDU from TopologyQuery interoperability (msg_id={message_id}): {e:?}");
+                        error!(%e, "Error forwarding SDU from TopologyQuery interoperability (msg_id={message_id})");
                     }
                 }
             }
@@ -188,7 +188,7 @@ impl CMDUHandler {
                         )
                         .await
                     {
-                        error!("Error forwarding SDU from TopologyResponse interoperability (msg_id={message_id}): {e:?}");
+                        error!(%e, "Error forwarding SDU from TopologyResponse interoperability (msg_id={message_id})");
                     }
                 }
             }
@@ -209,7 +209,7 @@ impl CMDUHandler {
                     )
                     .await
                 {
-                    error!("Error forwarding SDU from CMDU (msg_id={message_id}): {e:?}");
+                    error!(%e, "Error forwarding SDU from CMDU (msg_id={message_id})");
                 }
             }
         }
diff --git a/ieee1905-core/src/main.rs b/ieee1905-core/src/main.rs
index 248c134..a27b71f 100644
--- a/ieee1905-core/src/main.rs
+++ b/ieee1905-core/src/main.rs
@@ -18,6 +18,7 @@
 */
 
 #![deny(warnings)]
+
 use clap::Parser;
 use ieee1905::al_sap::AlServiceAccessPoint;
 use ieee1905::cmdu_handler::*;
@@ -30,6 +31,7 @@ use ieee1905::lldpdu_observer::LLDPObserver;
 use ieee1905::lldpdu_proxy::lldp_discovery_worker;
 use ieee1905::topology_manager::*;
 use ieee1905::{next_task_id, CMDUObserver};
+use std::ops::Not;
 //use ieee1905::crypto_engine::CRYPTO_CONTEXT;
 use std::sync::Arc;
 use std::time::Duration;
@@ -78,89 +80,11 @@ fn main() -> anyhow::Result<()> {
     // Start the Tokio console subscriber
     std::env::set_var("RUST_CONSOLE_BIND", "0.0.0.0:6669");
 
-    // Modify this filter for your tracing during run time
-    let filter =
-        EnvFilter::try_from_default_env().unwrap_or_else(|_| EnvFilter::new(cli.filter.clone())); //add 'tokio=trace' to debug the runtime
-
-    // To show logs in stdout
-    let fmt_layer = tracing_subscriber::fmt::layer()
-        .with_target(true)
-        .with_level(true)
-        .with_span_events(FmtSpan::CLOSE);
-
-    let file_appender = rolling::daily("logs", "app.log");
-    let (non_blocking, _guard) = tracing_appender::non_blocking(file_appender);
-
-    let file_layer = tracing_subscriber::fmt::layer()
-        .with_writer(non_blocking)
-        .with_target(true)
-        .with_level(true)
-        .with_span_events(FmtSpan::CLOSE);
-
-    #[cfg(feature = "enable_tokio_console")]
-    {
-        // To register your tracing
-        if cli.console_subscriber {
-            if cli.topology_ui {
-                tracing_subscriber::registry()
-                    .with(file_layer)
-                    .with(filter)
-                    .with(console_subscriber::spawn())
-                    .init();
-            } else {
-                tracing_subscriber::registry()
-                    .with(file_layer)
-                    .with(filter)
-                    .with(fmt_layer)
-                    .with(console_subscriber::spawn())
-                    .init();
-            }
-        } else {
-            if cli.topology_ui {
-                tracing_subscriber::registry()
-                    .with(file_layer)
-                    .with(filter)
-                    .init();
-            } else {
-                tracing_subscriber::registry()
-                    .with(file_layer)
-                    .with(filter)
-                    .with(fmt_layer)
-                    .init();
-            }
-        }
-    }
-
-    #[cfg(not(feature = "enable_tokio_console"))]
-    {
-        tracing::info!("Tokio console: Disabled");
-        if cli.topology_ui {
-            tracing_subscriber::registry()
-                .with(file_layer)
-                .with(filter)
-                //.with(fmt_layer)
-                .init();
-        } else {
-            tracing_subscriber::registry()
-                .with(file_layer)
-                .with(filter)
-                .with(fmt_layer)
-                .init();
-        }
-    }
-
-    tracing::debug!("Logger initialized with RUST_LOG."); // Start your application tracing
-
+    let _guard = init_logger(&cli);
     tracing::info!("Tracing initialized!");
 
     tracing::info!("Fragmentation type: SIZE BASED");
 
-    #[cfg(feature = "enable_tokio_console")]
-    tracing::info!("Tokio console: Enabled");
-
-    #[cfg(not(feature = "enable_tokio_console"))]
-    tracing::info!("Tokio console: Disabled");
-
     tracing::info!("TOPOLOGY_UI {:?}", cli.topology_ui);
 
     //ADDING logic for CRYPTO_CONTEXT here
@@ -189,6 +113,47 @@ fn main() -> anyhow::Result<()> {
     Ok(())
 }
 
+fn init_logger(cli: &CliArgs) -> impl Drop {
+    // modify this filter for your tracing during run time
+    let filter = EnvFilter::try_from_default_env().unwrap_or_else(|_| EnvFilter::new(&cli.filter));
+
+    // logging to stdout
+    let fmt_layer = tracing_subscriber::fmt::layer()
+        .with_target(true)
+        .with_level(true)
+        .with_span_events(FmtSpan::CLOSE);
+
+    // logging to fs
+    let file_appender = rolling::daily("logs", "app.log");
+    let (non_blocking, guard) = tracing_appender::non_blocking(file_appender);
+
+    let file_layer = tracing_subscriber::fmt::layer()
+        .with_writer(non_blocking)
+        .with_target(true)
+        .with_level(true)
+        .with_span_events(FmtSpan::CLOSE);
+
+    // combined logger
+    let logging_layer = file_layer.and_then(cli.topology_ui.not().then_some(fmt_layer));
+
+    #[cfg(feature = "enable_tokio_console")]
+    if cli.console_subscriber {
+        tracing::info!("Tokio console: Enabled");
+        tracing_subscriber::registry()
+            .with(logging_layer.with_filter(filter))
+            .with(console_subscriber::spawn())
+            .init();
+        return guard;
+    }
+
+    tracing::info!("Tokio console: Disabled");
+    tracing_subscriber::registry()
+        .with(logging_layer)
+        .with(filter)
+        .init();
+    guard
+}
+
 #[instrument(skip_all, name = "main", fields(task = next_task_id()))]
 async fn run_main_logic(cli: &CliArgs) -> anyhow::Result<bool> {
     let mut join_sets = Vec::new();
-- 
2.51.2

