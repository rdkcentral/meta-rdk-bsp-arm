From c0753b8b8301d66ac3a389b54e8fd0c6ee43ea6e Mon Sep 17 00:00:00 2001
From: mdev <www.matrix.dev@gmail.com>
Date: Fri, 16 Jan 2026 12:05:24 +0200
Subject: [PATCH 3/3] fixes flags for logs output

---
 README.md                 | 18 ++++++++++++-
 ieee1905-core/src/main.rs | 54 ++++++++++++++++++++++-----------------
 2 files changed, 48 insertions(+), 24 deletions(-)

diff --git a/README.md b/README.md
index 3670771..4c791a6 100644
--- a/README.md
+++ b/README.md
@@ -448,13 +448,29 @@ journalctl -u ieee1905.service
 
 By default service run with topology CLI enabled, info log level, listening on ```eth0``` interface and unix sockets named ```/tmp/al_control_socket``` and ```/tmp/al_data_socket```.
 
-#### Enable topolgy CLI
+#### Enable topology CLI
 
 By default topology CLI is disabled.
 When topology CLI is enabled. Log files are saved to a file and will not appear on standard output.
 
 ```/usr/bin/ieee1905 -t```
 
+#### Console logger
+
+By default, logs will be printed to stdout. Use following command to disable stdout logging:
+```shell
+/usr/bin/ieee1905 --no-stdout-appender
+```
+
+#### File logger
+
+By default, file logger is disabled. To enable file logging use following arguments:
+```shell
+/usr/bin/ieee1905 --file-appender ./logs
+```
+
+This will write logs to the folder `./logs`. Those logs will be automatically rotated on a daily basis.
+
 #### Change log level
 
 To enable trace log:
diff --git a/ieee1905-core/src/main.rs b/ieee1905-core/src/main.rs
index a27b71f..90be627 100644
--- a/ieee1905-core/src/main.rs
+++ b/ieee1905-core/src/main.rs
@@ -31,7 +31,7 @@ use ieee1905::lldpdu_observer::LLDPObserver;
 use ieee1905::lldpdu_proxy::lldp_discovery_worker;
 use ieee1905::topology_manager::*;
 use ieee1905::{next_task_id, CMDUObserver};
-use std::ops::Not;
+use std::path::PathBuf;
 //use ieee1905::crypto_engine::CRYPTO_CONTEXT;
 use std::sync::Arc;
 use std::time::Duration;
@@ -41,7 +41,7 @@ use tokio::sync::oneshot;
 use tokio::sync::Mutex;
 use tracing::instrument;
 use tracing_subscriber::{prelude::*, EnvFilter};
-use tracing_appender::rolling;
+use tracing_appender::non_blocking::WorkerGuard;
 use tracing_subscriber::fmt::format::FmtSpan;
 
 #[derive(Parser)]
@@ -66,12 +66,12 @@ struct CliArgs {
     #[cfg(feature = "enable_tokio_console")]
     #[arg(short, long, default_value_t = false)]
     console_subscriber: bool,
-    /// Enable file appender
-    #[arg(long, default_value_t = false)]
-    file_appender: bool,
-    /// Disable stdout log
-    #[arg(short, long, default_value_t = false)]
-    stdout_apender: bool,
+    /// Enable file appender for logs
+    #[arg(long, value_name = "FOLDER")]
+    file_appender: Option<PathBuf>,
+    /// Disable stdout appender for logs
+    #[arg(long)]
+    no_stdout_appender: bool,
 }
 
 fn main() -> anyhow::Result<()> {
@@ -113,28 +113,35 @@ fn main() -> anyhow::Result<()> {
     Ok(())
 }
 
-fn init_logger(cli: &CliArgs) -> impl Drop {
+fn init_logger(cli: &CliArgs) -> Option<WorkerGuard> {
     // modify this filter for your tracing during run time
     let filter = EnvFilter::try_from_default_env().unwrap_or_else(|_| EnvFilter::new(&cli.filter));
 
     // logging to stdout
-    let fmt_layer = tracing_subscriber::fmt::layer()
-        .with_target(true)
-        .with_level(true)
-        .with_span_events(FmtSpan::CLOSE);
+    let fmt_layer = (!cli.no_stdout_appender && !cli.topology_ui).then(|| {
+        tracing_subscriber::fmt::layer()
+            .with_target(true)
+            .with_level(true)
+            .with_span_events(FmtSpan::CLOSE)
+    });
 
     // logging to fs
-    let file_appender = rolling::daily("logs", "app.log");
-    let (non_blocking, guard) = tracing_appender::non_blocking(file_appender);
+    let mut file_layer_guard = None;
+    let file_layer = cli.file_appender.as_ref().map(|folder| {
+        let file_appender = tracing_appender::rolling::daily(folder, "app.log");
+        let (non_blocking, guard) = tracing_appender::non_blocking(file_appender);
+
+        file_layer_guard = Some(guard);
 
-    let file_layer = tracing_subscriber::fmt::layer()
-        .with_writer(non_blocking)
-        .with_target(true)
-        .with_level(true)
-        .with_span_events(FmtSpan::CLOSE);
+        tracing_subscriber::fmt::layer()
+            .with_writer(non_blocking)
+            .with_target(true)
+            .with_level(true)
+            .with_span_events(FmtSpan::CLOSE)
+    });
 
     // combined logger
-    let logging_layer = file_layer.and_then(cli.topology_ui.not().then_some(fmt_layer));
+    let logging_layer = tracing_subscriber::Layer::and_then(fmt_layer, file_layer);
 
     #[cfg(feature = "enable_tokio_console")]
     if cli.console_subscriber {
@@ -143,7 +150,7 @@ fn init_logger(cli: &CliArgs) -> impl Drop {
             .with(logging_layer.with_filter(filter))
             .with(console_subscriber::spawn())
             .init();
-        return guard;
+        return file_layer_guard;
     }
 
     tracing::info!("Tokio console: Disabled");
@@ -151,7 +158,8 @@ fn init_logger(cli: &CliArgs) -> impl Drop {
         .with(logging_layer)
         .with(filter)
         .init();
-    guard
+
+    file_layer_guard
 }
 
 #[instrument(skip_all, name = "main", fields(task = next_task_id()))]
-- 
2.51.2

